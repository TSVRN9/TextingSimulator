<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Texting Simulator</title>
        <link href="./manifest.webmanifest" rel="manifest">
        <link href="./index.css" rel="stylesheet">
        <link rel="icon" type="image/x-icon" href="./favicon.ico">
        <link rel="apple-touch-icon" href="./assets/icons/512x512.png">
        <style>
            [x-cloak] { display: none !important; }
        </style>
        <script defer src="./index.js" type="module"></script>
    </head>
    <body class="bg-black text-xs md:text-base">
        <!-- Change toInitialize to 2 -->
        <div class="pb-6" x-data="{ password: $persist(''), filename: $persist(''), messageData: {}, initialized: 0, toInitialize: 2, inputPassword: $persist(false) }">
            <div x-data x-init="if (params.has('password')) { search(params.get('password')).then(res => [filename, messageData] = res).catch(() => {}).finally(() => initialized++) } else initialized++"></div>
            <div x-data x-init="decrypt(password, filename).then(v => messageData = v).catch(() => {}).finally(() => initialized++ );"></div>

            <!-- This monster is going to manage pretty much all of the game state. answered represents the choices chosen -->
            <template x-if="initialized == toInitialize && Object.keys(messageData).length">
                <div class="flex flex-col max-w-2xl" x-data="{ toDisplay: $persist([]).using(sessionStorage), currentIndex: $persist(0).using(sessionStorage), currentName: $persist('start').using(sessionStorage), initialDelay: 1000, delay: 100, delayPerLetter: 10, choicesChosen: $persist([]).using(sessionStorage) }" x-init="
$watch('messageData', () => {
    if (messageData === {})
        toDisplay = [];
    currentIndex = 0;
    choicesChosen = [];
    currentName = 'start';
});
$watch('toDisplay', () => {
    if (toDisplay.length === 0) return;

    if (currentIndex != messageData[currentName].length) {

        const next = messageData[currentName][currentIndex];
        
        if (currentIndex === messageData[currentName].length - 1 && typeof next === 'string') {
            currentName = next;
        } else {
            currentIndex++;
            setTimeout(() => {
                toDisplay.push(next);
            }, delay + next.length * delayPerLetter);
        }
    }
});
$watch('currentName', () => {
    if (currentName == 'start') {
        choicesChosen = [];
        toDisplay.length = 0;
    }
    
    currentIndex = 0;
    const next = messageData[currentName][currentIndex];
    
    if (currentIndex === messageData[currentName].length - 1 && typeof next === 'string') {
        currentName = next;
    } else {
        setTimeout(() => {
            currentIndex++;
            toDisplay.push(next);
        }, delay + next.length * delayPerLetter);
    }
});
setTimeout(() => {
    if (toDisplay != [] && currentIndex != messageData[currentName].length) {
        const next = messageData[currentName][currentIndex];
        if (currentIndex === messageData[currentName].length - 1 && typeof next === 'string') {
            currentName = next;
        } else {
            currentIndex++;
            toDisplay.push(next);
        }
    }
})
new ResizeObserver(scrollToBottom).observe($el);
                ">
                    <template x-for="(d, i) in toDisplay" :key="i">
                        <div x-data="{ show: false }" x-init="setTimeout(() => show = true, 0)">
                            <!-- Represents someone elses message -->
                            <div x-show="show && typeof d === 'string'" x-transition>
                                <div>
                                    <div class="text-bubble" x-text="d"></div>
                                    <div class="text-triangle"></div>
                                </div>
                            </div>
                            <!-- Represents user choice -->
                            <template x-if="d instanceof Object">
                                <div class="flex justify-around items-center flex-row mt-6 min-h-xs" x-data="{ choices: Object.keys(d), chosen: $persist(false).as('_x_choice_' + i).using(sessionStorage) }" x-init="chosen = choicesChosen.indexOf(chosen) >= 0 ? chosen : false">
                                    <template x-for="choice in choices">
                                        <div x-show="show" x-transition>
                                            <button class="ease-in-out duration-100 bg-white rounded-xl p-4" :class="chosen === false ? '' : (chosen === choice ? '' : 'p-2 bg-gray-700')" x-text="choice" @click="chosen = choice; choicesChosen.push(choice); if (d[choice] === 'exit') { inputPassword = true } else { currentName = d[choice] }" :disabled="chosen"></button>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                    <div x-show="!messageData[currentName] || currentIndex != messageData[currentName].length" x-transition x-transition:leave.duration.0ms>
                        <div class="text-bubble"><span class="animate-pulse">⬤</span><span class="animate-pulse animation-delay-150">⬤</span><span class="animate-pulse animation-delay-300">⬤</span></div>
                        <div class="text-triangle"></div>
                    </div>
                    <!-- Display scroll to bottom button -->
                    <div x-data="{ clicked: false, show: false }" x-show="show && !clicked" x-init="document.addEventListener('scroll', () => { show = distanceToBottom() >= window.innerHeight / 3; if (distanceToBottom() == 0) clicked = false; }); $watch('currentName', () => { if (currentName === 'start') clicked = true });" x-transition x-transition:leave.duration.0ms class="flex justify-center fixed bottom-8 w-full pointer-events-none">
                        <button class="rounded-full text-white bg-blue-300 pointer-events-auto w-8 h-8 text-center p-1 animate-bounce" @click="clicked = true; scrollToBottom();">
                            <svg class="block mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m0 0l6.75-6.75M12 19.5l-6.75-6.75" />
                            </svg>
                        </button>
                    </div>
                </div>
            </template>

            <template 
                x-if="inputPassword || (initialized == toInitialize && !Object.keys(messageData).length)"
                x-transition
                >
                <div class="fixed top-0 left-0 backdrop-blur-sm flex justify-center items-center h-screen w-screen">
                    <form @submit.prevent="search(password).then(res => [filename, messageData] = res).catch(() => messageData = {}); inputPassword = false">
                        <div class="text-slate-700 flex flex-col gap-y-5 py-10 px-10 md:px-10 rounded-2xl bg-slate-500 m-20 max-w-xl">
                            <input class="p-4 text-center rounded-full border-2 border-transparent focus:outline-none hover:border-slate-600 focus:ring-4 focus:ring-slate-600" name="password" placeholder="Enter Password" x-model:value="password">
                            <input class="mx-20 rounded-full border-transparent border-2 bg-white hover:border-slate-600 focus:ring-4 focus:ring-slate-600 active:bg-slate-200" type="submit" value="Enter">
                        </div>
                    </form>
                </div>
            </template>
        </div>
    </body> 
</html>